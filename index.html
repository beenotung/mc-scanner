<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MC Scanner</title>
    <style>
      table {
        border-collapse: collapse;
      }
      th,
      td {
        border: 1px solid black;
        padding: 0.5rem;
        width: 2.25rem;
        height: 2.25rem;
        text-align: center;
      }
      .mc-table {
        user-select: none;
        height: fit-content;
      }
      .button-group,
      .input-field {
        display: block;
        margin: 1rem;
      }
      .button-group {
        display: flex;
        gap: 1rem;
      }
      #tablesContainer {
        width: fit-content;
      }
      #camera {
        position: fixed;
        inset: 0;
        pointer-events: none;
        z-index: 1;
        opacity: 0.5;
        object-fit: cover;
      }
    </style>
  </head>
  <body>
    <table id="demoTable" class="mc-table" style="margin: 1rem">
      <thead>
        <tr>
          <th>題號</th>
          <th>A</th>
          <th>B</th>
          <th>C</th>
          <th>D</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>示範</td>
          <td></td>
          <td></td>
          <td>✓</td>
          <td></td>
        </tr>
      </tbody>
    </table>
    <label class="input-field">
      Total Questions:
      <input
        type="number"
        id="totalQuestions"
        value="24"
        min="1"
        style="width: 4rem; margin: 0 0.5rem"
      />
    </label>
    <label class="input-field">
      Questions per Table:
      <input
        type="number"
        id="questionsPerTable"
        value="8"
        min="1"
        style="width: 4rem; margin: 0 0.5rem"
      />
    </label>
    <div class="button-group">
      <button onclick="startCamera()">Start Camera</button>
      <button onclick="stopCamera()">Stop Camera</button>
    </div>
    <div class="button-group">
      <button onclick="shareData()">Share</button>
      <button onclick="copyData()">Copy</button>
    </div>
    <div class="button-group">
      <button onclick="clearData()">Clear</button>
    </div>
    <video id="camera" muted playsinline></video>
    <div id="tablesContainer" style="display: flex; flex-wrap: wrap"></div>
    <script>
      function saveAnswer(id, option) {
        if (option > 0) {
          localStorage.setItem('mcAnswer_' + id, option)
        } else {
          localStorage.removeItem('mcAnswer_' + id)
        }
      }

      let answerMark = '✓'

      function renderTable(table, start, end) {
        table.innerHTML = demoTable.innerHTML
        table.querySelector('tbody tr').remove()
        let tBody = table.querySelector('tbody')
        for (let i = start; i <= end; i++) {
          let savedOption = +localStorage.getItem('mcAnswer_' + i)

          let row = tBody.insertRow()
          row.insertCell().textContent = i
          let a = row.insertCell()
          let b = row.insertCell()
          let c = row.insertCell()
          let d = row.insertCell()
          let options = [a, b, c, d]

          for (
            let optionIndex = 0;
            optionIndex < options.length;
            optionIndex++
          ) {
            let option = options[optionIndex]
            if (savedOption === optionIndex + 1) {
              option.textContent = answerMark
            }
            option.onclick = () => {
              for (let option of options) {
                option.textContent = ''
              }
              option.textContent = answerMark
              saveAnswer(i, optionIndex + 1)
            }
          }
        }
      }

      function updateTables() {
        let total = parseInt(totalQuestions.value) || 24
        let perTable = parseInt(questionsPerTable.value) || 8
        let tablesContainer = document.getElementById('tablesContainer')
        tablesContainer.innerHTML = ''

        for (let i = 0; i < total; i += perTable) {
          let start = i + 1
          let end = Math.min(i + perTable, total)
          let table = document.createElement('table')
          table.className = 'mc-table'
          tablesContainer.appendChild(table)
          renderTable(table, start, end)
        }
      }

      function clearData() {
        for (let row of document.querySelectorAll(
          '#tablesContainer tbody tr',
        )) {
          let cells = row.querySelectorAll('td')
          let id = +cells[0].textContent
          if (!id) {
            continue
          }
          for (let i = 1; i < cells.length; i++) {
            cells[i].textContent = ''
          }
        }
      }

      // Load saved settings
      let savedTotal = localStorage.getItem('mcTotalQuestions')
      if (savedTotal) {
        totalQuestions.value = savedTotal
      }
      let savedPerTable = localStorage.getItem('mcQuestionsPerTable')
      if (savedPerTable) {
        questionsPerTable.value = savedPerTable
      }

      updateTables()

      totalQuestions.addEventListener('input', () => {
        localStorage.setItem('mcTotalQuestions', totalQuestions.value)
        updateTables()
      })
      questionsPerTable.addEventListener('input', () => {
        localStorage.setItem('mcQuestionsPerTable', questionsPerTable.value)
        updateTables()
      })

      async function startCamera() {
        let tables = document.querySelectorAll('#tablesContainer .mc-table')
        if (tables.length === 0) {
          alert('Please create tables first')
          return
        }
        let rect = tables[0].parentElement.getBoundingClientRect()
        camera.style.width = rect.width + 'px'
        camera.style.height = rect.height + 'px'
        camera.style.top = rect.top + 'px'
        camera.style.left = rect.left + 'px'
        let stream = await navigator.mediaDevices.getUserMedia({
          video: {
            facingMode: 'environment',
            // width: { ideal: rect.width },
            // height: { ideal: rect.height },
          },
          audio: false,
        })
        camera.srcObject = stream
        camera.play()
      }

      function stopCamera() {
        let stream = camera.srcObject
        let tracks = stream.getTracks()
        for (let track of tracks) {
          track.stop()
        }
        camera.srcObject = null
        camera.pause()
      }

      function exportData() {
        let answers = []
        for (let row of document.querySelectorAll('tbody tr')) {
          let cells = row.querySelectorAll('td')
          let id = +cells[0].textContent
          if (!id) {
            continue
          }
          let option = Array.from(cells).findIndex(
            cell => cell.textContent === '✓',
          )
          if (option == -1) {
            option = 0
          }
          answers.push({ id, option })
        }
        let seat = prompt('Seat no:')
        let json = { seat, answers }
        let text = JSON.stringify(json)
        return { seat, answers, text }
      }

      async function shareData() {
        let { seat, answers, text } = exportData()
        navigator.share({
          title: 'MC of seat: ' + seat,
          text,
        })
      }

      function copyData() {
        let { text } = exportData()
        let textarea = document.createElement('textarea')
        document.body.prepend(textarea)
        textarea.value = text
        textarea.select()
        let result = document.execCommand('copy')
        if (result) {
          alert('Copied to clipboard')
          textarea.remove()
        } else {
          alert('Please copy the text manually')
        }
      }
    </script>
  </body>
</html>
